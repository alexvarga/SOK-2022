{% extends "core/base.html" %}
{% block style %}
    <style>

        .node {
            cursor: pointer;
            color: #3182bd;

        }

        .link {
            fill: none;
            stroke: #9ecae1;
            stroke-width: 1.5px;
        }

    </style>

{% endblock %}
{% block content %}

    <div class="center">
        <svg id="force" width="800" height="800">

        </svg>
    </div>

    <script>


        var nodes = {
            {%if nodes.items%}
                "node_{{root.id}}":
                    {
                        name: "node_{{root.id}}", naziv: "{{root.label}}",
                        attributes: [
                            {% for a in root.attributes.all %}
                                {name: "attribute_{{a.id}}", naziv: "{{a.name}}", vrednost: "{{a.value}}"},
                            {% endfor %}
                        ]
                    },
                {% for n, values in nodes.items %}
                    "node_{{n.id}}": {

                        name: "node_{{n.id}}", naziv: "{{n.label}}",
                        attributes: [
                            {% for a in n.attributes.all %}
                                {name: "attribute_{{a.id}}", naziv: "{{a.name}}", vrednost: "{{a.value}}"},
                            {% endfor %}
                        ]
                    },
                    {%include "visualization/nodes_recursive_template.html" %}

                {% endfor %}
            {% endif %}

        };


        var links = [
            {% for n, values in nodes.items %}
                {source: "node_{{root.id}}", target: "node_{{n.id}}"},
                {%include "visualization/linking_recursive.html" %}
            {% endfor %}
            {% for n,values in nodes.items %}
                {source: "node_{{root.id}}", target: "node_{{n.id}}"},
                {%include "visualization/linking_recursive.html" %}

            {% endfor %}
        ];
        console.log((links))


        links.forEach(function (link) {
            link.source = nodes[link.source];
            link.target = nodes[link.target];
        });


        var force = d3.layout.force()
            .size([500, 500])
            .nodes(d3.values(nodes))
            .links(links)
            .on("tick", tick)
            .linkDistance(300)
            .charge(-1000)
            .start();


        var ln1 = [];

        var i;
        for (i = 0; i < links.length / 2; i++) {
            ln1.push(links[i]);
        }

        var svg = d3.select('#force')
            .call(d3.behavior.zoom().on("zoom", function () {
                svg.attr("transform", "translate(" + d3.event.translate + ")" + "scale(" + d3.event.scale + ")")
            }))
            .append("g")
            .attr("transform", "translate(0,0)");


        // add the links
        var link = svg.selectAll('.link')
            .data(ln1)
            .enter().append('line')
            .attr('class', 'link');


        // add the nodes
        var node = svg.selectAll('.node')
            .data(force.nodes()) //add
            .enter().append('g')
            .attr('class', 'node')
            .attr('id', function (d) {
                return d.name;
            })

            .on('click', function () {

            });


        d3.selectAll('.node').each(function (d) {
            show(d);
        });


        function show(d) {
            var attributesNo = d.attributes.length;
            console.log(attributesNo)
            var duzina = 100;
            var textSize = 15;

            if (attributesNo == 0) {
                visina = 15;
            } else {
                visina = attributesNo * textSize
            }
            visina += textSize;


            //Ubacivanje kvadrata
            d3.select("g#" + d.name).append('rect').attr('x', 0).attr('y', 0).attr('width', duzina).attr('height', visina)
                .attr('fill', 'gray');
            //Ubacivanje naziva cvora
            d3.select("g#" + d.name).append('text').attr('x', duzina / 2).attr('y', 10)
                .attr('text-anchor', 'middle')
                .attr('font-size', textSize).attr('font-family', 'sans-serif')
                .attr('fill', 'green').text(d.naziv);

            for (var i = 0; i < attributesNo; i++) {
                //Ubacivanje naziva atributa=vrednost
                d3.select("g#" + d.name).append('text').attr('x', 0).attr('y', 20 + i * textSize)
                    .attr('text-anchor', 'start')
                    .attr('font-size', textSize).attr('font-family', 'sans-serif')
                    .attr('fill', 'black').text(d.attributes[i].naziv + " = " + d.attributes[i].vrednost);

            }

        }


        function tick(e) {
            node.attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            })
                .call(force.drag);

            link.attr('x1', function (d) {
                return d.source.x;
            })
                .attr('y1', function (d) {
                    return d.source.y;
                })
                .attr('x2', function (d) {
                    return d.target.x;
                })
                .attr('y2', function (d) {
                    return d.target.y;
                })


        }


    </script>





{% endblock %}